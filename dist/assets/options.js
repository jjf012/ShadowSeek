import{d as kt,a as ft,r as p,c as bt,o as gt,b as a,e as i,f as l,w as u,v as D,l as m,m as L,p as O,F as R,j as T,h as k,t as f,g as K,q as yt,s as ht,k as Bt}from"./runtime-dom.esm-bundler.js";import{g as _t,l as wt,a as Ct,s as xt,D as A,b as St}from"./rulesStore.js";const Ut={class:"options"},Vt={class:"panel"},Mt={class:"row"},Rt={class:"row"},Tt={class:"row"},It={class:"row"},Dt={class:"row"},Lt={class:"panel"},Ot={class:"blacklist-grid"},Kt={class:"bl-card"},At={class:"bl-head"},Et={class:"bl-actions"},$t=["disabled"],Ft={class:"input-row"},Nt=["onKeyup"],jt=["disabled"],qt={key:0,class:"chips"},zt=["onClick"],Jt={key:1,class:"hint"},Pt={class:"bl-card"},Gt={class:"bl-head"},Ht={class:"bl-actions"},Qt=["disabled"],Wt={class:"input-row"},Xt=["onKeyup"],Yt=["disabled"],Zt={key:0,class:"chips"},tl=["onClick"],ll={key:1,class:"hint"},el={class:"panel"},sl={class:"blacklist-grid"},nl={class:"bl-card"},ol={class:"bl-head"},al={class:"bl-actions"},il=["disabled"],ul={class:"input-row"},cl=["onKeyup"],dl=["disabled"],rl={key:0,class:"chips"},pl=["onClick"],vl={key:1,class:"hint"},ml={class:"panel"},kl={class:"toolbar"},fl={class:"rules-table"},bl={class:"col name"},gl=["onUpdate:modelValue"],yl={class:"rule-name"},hl={class:"rule-cat"},Bl={class:"col sev"},_l=["title"],wl={class:"col act"},Cl=["onClick"],xl=["onClick"],Sl={key:0,class:"subtle"},Ul={key:0,class:"modal-backdrop"},Vl={class:"modal"},Ml={class:"form-grid"},Rl={class:"span-2"},Tl={class:"span-2"},Il={key:0,class:"error"},Dl={class:"actions"},Ll=["disabled"],Ol={class:"status"},Kl=kt({__name:"Options",setup(Al){const n=ft({includeInline:!0,maxContentSizeKB:5e3,requestTimeoutMs:2e4,scanTimeoutMs:3e3,autoScan:!1,outputBlacklist:[],domainBlacklist:[],fileBlacklist:[]}),x=p(5),S=p(2e4),U=p(3e3),B=p(""),_=p(""),w=p(""),V=p(!1),g=p(""),I=p(""),v=p([]),q=new Set(_t().map(s=>s.id)),M=p(null),o=p(null),y=p("");async function z(){const s=await wt();Object.assign(n,s),n.outputBlacklist=c(n.outputBlacklist),n.domainBlacklist=c(n.domainBlacklist),n.fileBlacklist=c(n.fileBlacklist),x.value=Math.max(1,Math.round((s.maxContentSizeKB??5e3)/1024)),S.value=s.requestTimeoutMs??2e4,U.value=s.scanTimeoutMs??3e3,v.value=await Ct()}function c(s){const t=new Set,e=[];for(const r of s){const b=(r||"").trim();if(!b)continue;const h=b.toLowerCase();t.has(h)||(t.add(h),e.push(b))}return e}async function J(){V.value=!0,await xt({...n,maxContentSizeKB:x.value*1024,requestTimeoutMs:S.value,scanTimeoutMs:U.value,outputBlacklist:c(n.outputBlacklist),domainBlacklist:c(n.domainBlacklist),fileBlacklist:c(n.fileBlacklist)}),g.value="已保存",V.value=!1}async function P(){await chrome.runtime.sendMessage({type:"CLEAR_DATA"}),g.value="数据已清空"}function G(s,t){return s.length<=t?s:`${s.slice(0,t-3)}...`}function E(){const s=B.value.trim();if(!s)return;const t=c([...n.domainBlacklist,s]);n.domainBlacklist.splice(0,n.domainBlacklist.length,...t),B.value=""}function $(){const s=_.value.trim();if(!s)return;const t=c([...n.fileBlacklist,s]);n.fileBlacklist.splice(0,n.fileBlacklist.length,...t),_.value=""}function H(s){const t=n.domainBlacklist.indexOf(s);t>=0&&n.domainBlacklist.splice(t,1)}function Q(s){const t=n.fileBlacklist.indexOf(s);t>=0&&n.fileBlacklist.splice(t,1)}function W(){const s=c([...A.domainBlacklist??[]]),t=c([...n.domainBlacklist,...s]);n.domainBlacklist.splice(0,n.domainBlacklist.length,...t)}function X(){const s=c([...A.fileBlacklist??[]]),t=c([...n.fileBlacklist,...s]);n.fileBlacklist.splice(0,n.fileBlacklist.length,...t)}function Y(){n.domainBlacklist.splice(0,n.domainBlacklist.length)}function Z(){n.fileBlacklist.splice(0,n.fileBlacklist.length)}function F(){const s=w.value.trim();if(!s)return;const t=c([...n.outputBlacklist,s]);n.outputBlacklist.splice(0,n.outputBlacklist.length,...t),w.value=""}function tt(s){const t=n.outputBlacklist.indexOf(s);t>=0&&n.outputBlacklist.splice(t,1)}function lt(){n.outputBlacklist.splice(0,n.outputBlacklist.length)}function et(){const s=c([...A.outputBlacklist??[]]),t=c([...n.outputBlacklist,...s]);n.outputBlacklist.splice(0,n.outputBlacklist.length,...t)}const N=bt(()=>{const s=I.value.trim().toLowerCase();return s?v.value.filter(t=>t.name.toLowerCase().includes(s)||t.category.toString().toLowerCase().includes(s)||t.pattern.toLowerCase().includes(s)):v.value});function st(){C()}function nt(s){o.value={...s},y.value=""}function ot(){o.value={id:`custom-${Date.now()}`,name:"",description:"",category:"credential",severity:"medium",pattern:"",flags:"gi",enabled:!0},y.value=""}function at(){o.value=null,y.value=""}function it(s){if(!s.name.trim())return"名称不能为空";if(!s.pattern.trim())return"正则不能为空";try{new RegExp(s.pattern,s.flags||"gi")}catch(t){return`正则无效: ${t?.message??t}`}return null}async function ut(){if(!o.value)return;const s=it(o.value);if(s){y.value=s;return}const t=v.value.findIndex(e=>e.id===o.value.id);t>=0?v.value[t]={...o.value}:v.value.push({...o.value}),await C(),o.value=null}async function ct(s){if(q.has(s.id)){s.enabled=!1,await C();return}v.value=v.value.filter(t=>t.id!==s.id),await C()}async function C(){await St(v.value),g.value="规则已保存"}function dt(){M.value?.click()}async function rt(s){const e=s.target.files?.[0];if(!e)return;const r=await e.text();try{const b=JSON.parse(r),h=Array.isArray(b)?b:b.rules;if(!Array.isArray(h))throw new Error("格式不正确，应为数组或 { rules: [] }");const vt=[...v.value],j=new Map(vt.map(d=>[d.id,d]));for(const d of h){if(!d.id||!d.name||!d.pattern)continue;const mt={id:d.id,name:d.name,description:d.description??"",category:d.category??"credential",severity:d.severity??"medium",pattern:d.pattern,flags:d.flags??"gi",enabled:d.enabled??!0};j.set(d.id,mt)}v.value=Array.from(j.values()),await C(),g.value=`已导入 ${h.length} 条规则`}catch(b){g.value=`导入失败: ${b?.message??b}`}finally{M.value&&(M.value.value="")}}function pt(){const s=JSON.stringify({rules:v.value},null,2),t=new Blob([s],{type:"application/json"}),e=URL.createObjectURL(t),r=document.createElement("a");r.href=e,r.download="shadowseek-rules.json",r.click(),URL.revokeObjectURL(e)}return gt(()=>{z()}),(s,t)=>(i(),a("main",Ut,[t[37]||(t[37]=l("header",null,[l("h1",null,"ShadowSeek 设置"),l("p",{class:"sub"},"配置扫描策略与性能限制")],-1)),l("section",Vt,[t[20]||(t[20]=l("h2",null,"扫描策略",-1)),l("label",Mt,[u(l("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>n.includeInline=e),type:"checkbox"},null,512),[[D,n.includeInline]]),t[15]||(t[15]=l("span",null,"包含内联脚本",-1))]),l("label",Rt,[u(l("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>n.autoScan=e),type:"checkbox"},null,512),[[D,n.autoScan]]),t[16]||(t[16]=l("span",null,"自动扫描新标签页（完成加载后自动触发）",-1))]),l("label",Tt,[t[17]||(t[17]=l("span",null,"单文件最大体积 (MB)",-1)),u(l("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>x.value=e),type:"number",min:"1",step:"1"},null,512),[[m,x.value,void 0,{number:!0}]])]),l("label",It,[t[18]||(t[18]=l("span",null,"请求超时 (ms)",-1)),u(l("input",{"onUpdate:modelValue":t[3]||(t[3]=e=>S.value=e),type:"number",min:"1000",step:"1000"},null,512),[[m,S.value,void 0,{number:!0}]])]),l("label",Dt,[t[19]||(t[19]=l("span",null,"正则分析超时 (ms)",-1)),u(l("input",{"onUpdate:modelValue":t[4]||(t[4]=e=>U.value=e),type:"number",min:"500",step:"500"},null,512),[[m,U.value,void 0,{number:!0}]])])]),l("section",Lt,[t[23]||(t[23]=l("h2",null,"黑名单（命中即跳过扫描）",-1)),t[24]||(t[24]=l("p",{class:"sub"},"域名与文件名与内置规则一同生效，可用于加速或减少噪声。",-1)),l("div",Ot,[l("div",Kt,[l("div",At,[t[21]||(t[21]=l("div",null,[l("span",{class:"bl-title"},"域名黑名单"),l("small",{class:"hint"},"后缀匹配：输入 example.com 将匹配 example.com 与 *.example.com")],-1)),l("div",Et,[l("button",{class:"tiny ghost",onClick:W},"添加推荐"),l("button",{class:"tiny ghost",disabled:!n.domainBlacklist.length,onClick:Y},"清空",8,$t)])]),l("div",Ft,[u(l("input",{"onUpdate:modelValue":t[5]||(t[5]=e=>B.value=e),class:"mono",type:"text",placeholder:"输入域名后按回车添加，例如 google-analytics.com",onKeyup:L(O(E,["prevent"]),["enter"])},null,40,Nt),[[m,B.value]]),l("button",{class:"tiny",disabled:!B.value.trim(),onClick:E},"添加",8,jt)]),n.domainBlacklist.length?(i(),a("div",qt,[(i(!0),a(R,null,T(n.domainBlacklist,e=>(i(),a("span",{key:e,class:"chip"},[k(f(e)+" ",1),l("button",{class:"chip-remove",onClick:r=>H(e),"aria-label":"移除"},"×",8,zt)]))),128))])):(i(),a("p",Jt,"尚未添加域名，可添加常见统计/CDN 域名以减少噪声。"))]),l("div",Pt,[l("div",Gt,[t[22]||(t[22]=l("div",null,[l("span",{class:"bl-title"},"文件名/路径黑名单"),l("small",{class:"hint"},"包含匹配：路径中包含关键词即跳过，如 .map、/vendor、chunk-vendors")],-1)),l("div",Ht,[l("button",{class:"tiny ghost",onClick:X},"添加推荐"),l("button",{class:"tiny ghost",disabled:!n.fileBlacklist.length,onClick:Z},"清空",8,Qt)])]),l("div",Wt,[u(l("input",{"onUpdate:modelValue":t[6]||(t[6]=e=>_.value=e),class:"mono",type:"text",placeholder:"输入文件名/路径片段后回车添加，例如 .map /vendor",onKeyup:L(O($,["prevent"]),["enter"])},null,40,Xt),[[m,_.value]]),l("button",{class:"tiny",disabled:!_.value.trim(),onClick:$},"添加",8,Yt)]),n.fileBlacklist.length?(i(),a("div",Zt,[(i(!0),a(R,null,T(n.fileBlacklist,e=>(i(),a("span",{key:e,class:"chip"},[k(f(e)+" ",1),l("button",{class:"chip-remove",onClick:r=>Q(e),"aria-label":"移除"},"×",8,tl)]))),128))])):(i(),a("p",ll,"尚未添加文件/路径，可添加 .map、chunk-vendors、react.production.min.js 等。"))])])]),l("section",el,[t[26]||(t[26]=l("h2",null,"输出黑名单（命中即忽略结果）",-1)),t[27]||(t[27]=l("p",{class:"sub"},[k("用于过滤常见噪声：匹配到的值将不保存/不展示。支持以 "),l("code",null,"*"),k(" 结尾的前缀匹配。")],-1)),l("div",sl,[l("div",nl,[l("div",ol,[t[25]||(t[25]=l("div",null,[l("span",{class:"bl-title"},"输出黑名单"),l("small",{class:"hint"},"包含匹配：如 /dist/、/node_modules/；前缀匹配：如 http://www.w3.org/*、text/*")],-1)),l("div",al,[l("button",{class:"tiny ghost",onClick:et},"添加推荐"),l("button",{class:"tiny ghost",disabled:!n.outputBlacklist.length,onClick:lt},"清空",8,il)])]),l("div",ul,[u(l("input",{"onUpdate:modelValue":t[7]||(t[7]=e=>w.value=e),class:"mono",type:"text",placeholder:"输入要忽略的值/片段后回车添加，例如 text/* 或 http://www.w3.org/*",onKeyup:L(O(F,["prevent"]),["enter"])},null,40,cl),[[m,w.value]]),l("button",{class:"tiny",disabled:!w.value.trim(),onClick:F},"添加",8,dl)]),n.outputBlacklist.length?(i(),a("div",rl,[(i(!0),a(R,null,T(n.outputBlacklist,e=>(i(),a("span",{key:e,class:"chip"},[k(f(e)+" ",1),l("button",{class:"chip-remove",onClick:r=>tt(e),"aria-label":"移除"},"×",8,pl)]))),128))])):(i(),a("p",vl,"尚未添加输出黑名单，可用于过滤 w3.org 命名空间、text/css 等噪声。"))])])]),l("section",ml,[t[36]||(t[36]=l("h2",null,"规则管理",-1)),l("div",kl,[l("button",{class:"primary",onClick:ot},"新增规则"),l("button",{class:"ghost",onClick:dt},"导入"),l("button",{class:"ghost",onClick:pt},"导出"),u(l("input",{"onUpdate:modelValue":t[8]||(t[8]=e=>I.value=e),class:"search",placeholder:"搜索名称/类别"},null,512),[[m,I.value]]),l("input",{ref_key:"ruleFileInput",ref:M,type:"file",accept:"application/json",class:"hidden",onChange:rt},null,544)]),l("div",fl,[t[28]||(t[28]=yt('<div class="rule-row head"><span class="col name">名称 / 类别</span><span class="col sev">等级</span><span class="col pat">正则</span><span class="col act">操作</span></div>',1)),(i(!0),a(R,null,T(N.value,e=>(i(),a("div",{key:e.id,class:"rule-row"},[l("label",bl,[u(l("input",{type:"checkbox","onUpdate:modelValue":r=>e.enabled=r,onChange:st},null,40,gl),[[D,e.enabled]]),l("span",yl,f(e.name),1),l("span",hl,f(e.category),1)]),l("span",Bl,f(e.severity),1),l("span",{class:"col pat",title:e.pattern},f(G(e.pattern,60)),9,_l),l("span",wl,[l("button",{class:"tiny",onClick:r=>nt(e)},"编辑",8,Cl),l("button",{class:"tiny ghost",onClick:r=>ct(e)},"删除",8,xl)])]))),128)),N.value.length?K("",!0):(i(),a("p",Sl,"暂无规则"))]),o.value?(i(),a("div",Ul,[l("div",Vl,[l("h3",null,f(o.value.id?"编辑规则":"新增规则"),1),l("div",Ml,[l("label",null,[t[29]||(t[29]=k(" 名称 ",-1)),u(l("input",{"onUpdate:modelValue":t[9]||(t[9]=e=>o.value.name=e)},null,512),[[m,o.value.name]])]),l("label",null,[t[30]||(t[30]=k(" 类别 ",-1)),u(l("input",{"onUpdate:modelValue":t[10]||(t[10]=e=>o.value.category=e),placeholder:"credential/cloud/db/pii/endpoint..."},null,512),[[m,o.value.category]])]),l("label",null,[t[32]||(t[32]=k(" 严重级别 ",-1)),u(l("select",{"onUpdate:modelValue":t[11]||(t[11]=e=>o.value.severity=e)},[...t[31]||(t[31]=[l("option",{value:"critical"},"critical",-1),l("option",{value:"high"},"high",-1),l("option",{value:"medium"},"medium",-1),l("option",{value:"low"},"low",-1)])],512),[[ht,o.value.severity]])]),l("label",null,[t[33]||(t[33]=k(" 正则 flags ",-1)),u(l("input",{"onUpdate:modelValue":t[12]||(t[12]=e=>o.value.flags=e),placeholder:"g, gi 等"},null,512),[[m,o.value.flags]])]),l("label",Rl,[t[34]||(t[34]=k(" 正则表达式 ",-1)),u(l("textarea",{"onUpdate:modelValue":t[13]||(t[13]=e=>o.value.pattern=e),rows:"3",placeholder:"请输入 JS 正则，不含外侧斜杠"},null,512),[[m,o.value.pattern]])]),l("label",Tl,[t[35]||(t[35]=k(" 描述 ",-1)),u(l("textarea",{"onUpdate:modelValue":t[14]||(t[14]=e=>o.value.description=e),rows:"2"},null,512),[[m,o.value.description]])])]),l("div",{class:"editor-actions"},[l("button",{class:"primary",onClick:ut},"保存"),l("button",{class:"ghost",onClick:at},"取消")]),y.value?(i(),a("p",Il,f(y.value),1)):K("",!0)])])):K("",!0)]),l("div",Dl,[l("button",{class:"primary",disabled:V.value,onClick:J},f(V.value?"保存中...":"保存设置"),9,Ll),l("button",{class:"ghost",onClick:P},"清空数据"),l("span",Ol,f(g.value),1)])]))}});Bt(Kl).mount("#app");
