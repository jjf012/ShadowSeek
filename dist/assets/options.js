import{d as q,f as h,h as J,i as H,c as f,o as g,a as e,b as I,w as v,v as w,s as Z,F as G,r as W,x as K,t as k,u as Q,l as U,y as ee,z as te,A as le,e as se,B as ne,g as oe,k as _,C as S,q as ae}from"./runtime-dom.esm-bundler.js";import{g as ie,l as ue,s as de,a as re,b as ce,d as pe,D as R}from"./rulesStore.js";function c(i){const l=new Set,d=[];for(const b of i){const a=(b||"").trim();if(!a)continue;const B=a.toLowerCase();l.has(B)||(l.add(B),d.push(a))}return d}function me(i){let l=(i||"").trim().toLowerCase();return!l||(l.startsWith(".")||(l=`.${l}`),l===".")?"":l}function ve(i,l){return i.length<=l?i:`${i.slice(0,l-3)}...`}const fe={class:"panel"},ge={class:"toolbar"},ke={class:"rules-table"},be={class:"col name"},ye=["onUpdate:modelValue"],he={class:"rule-name"},Be={class:"rule-cat"},we={class:"col sev"},xe=["title"],Ce={class:"col act"},Ue=["onClick"],$e=["onClick"],Ve={key:0,class:"subtle"},_e={key:0,class:"modal-backdrop"},Ie={class:"modal"},Ee={class:"form-grid"},Se={class:"span-2"},Re={class:"span-2"},Le={key:0,class:"error"},Me=q({__name:"RuleManager",emits:["status"],setup(i,{emit:l}){const d=l,b=h(""),a=h([]),B=new Set(ie().map(t=>t.id)),m=h(null),o=h(null),u=h(""),y=J(()=>{const t=b.value.trim().toLowerCase();return t?a.value.filter(s=>s.name.toLowerCase().includes(t)||s.category.toString().toLowerCase().includes(t)||s.pattern.toLowerCase().includes(t)):a.value});async function x(){a.value=await ue()}function E(){$()}function M(t){o.value={...t},u.value=""}function D(){o.value={id:`custom-${Date.now()}`,name:"",description:"",category:"credential",severity:"medium",pattern:"",flags:"gi",enabled:!0},u.value=""}function T(){o.value=null,u.value=""}function A(t){if(!t.name.trim())return"名称不能为空";if(!t.pattern.trim())return"正则不能为空";try{new RegExp(t.pattern,t.flags||"gi")}catch(s){return`正则无效: ${s?.message??s}`}return null}async function j(){if(!o.value)return;const t=A(o.value);if(t){u.value=t;return}const s=a.value.findIndex(n=>n.id===o.value.id);s>=0?a.value[s]={...o.value}:a.value.push({...o.value}),await $(),o.value=null}async function z(t){if(B.has(t.id)){t.enabled=!1,await $();return}a.value=a.value.filter(s=>s.id!==t.id),await $()}async function $(){await de(a.value),d("status","规则已保存")}function F(){m.value?.click()}async function N(t){const n=t.target.files?.[0];if(!n)return;const C=await n.text();try{const V=JSON.parse(C),O=Array.isArray(V)?V:V.rules;if(!Array.isArray(O))throw new Error("格式不正确，应为数组或 { rules: [] }");const X=[...a.value],P=new Map(X.map(p=>[p.id,p]));for(const p of O){if(!p.id||!p.name||!p.pattern)continue;const Y={id:p.id,name:p.name,description:p.description??"",category:p.category??"credential",severity:p.severity??"medium",pattern:p.pattern,flags:p.flags??"gi",enabled:p.enabled??!0};P.set(p.id,Y)}a.value=Array.from(P.values()),await $(),d("status",`已导入 ${O.length} 条规则`)}catch(V){d("status",`导入失败: ${V?.message??V}`)}finally{m.value&&(m.value.value="")}}function r(){const t=JSON.stringify({rules:a.value},null,2),s=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(s),C=document.createElement("a");C.href=n,C.download="shadowseek-rules.json",C.click(),URL.revokeObjectURL(n),d("status","已导出规则")}return H(()=>{x()}),(t,s)=>(g(),f("section",fe,[s[15]||(s[15]=e("h2",null,"规则管理",-1)),e("div",ge,[e("button",{class:"primary",onClick:D},"新增规则"),e("button",{class:"ghost",onClick:F},"导入"),e("button",{class:"ghost",onClick:r},"导出"),v(e("input",{"onUpdate:modelValue":s[0]||(s[0]=n=>b.value=n),class:"search",placeholder:"搜索名称/类别"},null,512),[[w,b.value]]),e("input",{ref_key:"ruleFileInput",ref:m,type:"file",accept:"application/json",class:"hidden",onChange:N},null,544)]),e("div",ke,[s[7]||(s[7]=Z('<div class="rule-row head"><span class="col name">名称 / 类别</span><span class="col sev">等级</span><span class="col pat">正则</span><span class="col act">操作</span></div>',1)),(g(!0),f(G,null,W(y.value,n=>(g(),f("div",{key:n.id,class:"rule-row"},[e("label",be,[v(e("input",{type:"checkbox","onUpdate:modelValue":C=>n.enabled=C,onChange:E},null,40,ye),[[K,n.enabled]]),e("span",he,k(n.name),1),e("span",Be,k(n.category),1)]),e("span",we,k(n.severity),1),e("span",{class:"col pat",title:n.pattern},k(Q(ve)(n.pattern,60)),9,xe),e("span",Ce,[e("button",{class:"tiny",onClick:C=>M(n)},"编辑",8,Ue),e("button",{class:"tiny ghost",onClick:C=>z(n)},"删除",8,$e)])]))),128)),y.value.length?I("",!0):(g(),f("p",Ve,"暂无规则"))]),o.value?(g(),f("div",_e,[e("div",Ie,[e("h3",null,k(o.value.id?"编辑规则":"新增规则"),1),e("div",Ee,[e("label",null,[s[8]||(s[8]=U(" 名称 ",-1)),v(e("input",{"onUpdate:modelValue":s[1]||(s[1]=n=>o.value.name=n)},null,512),[[w,o.value.name]])]),e("label",null,[s[9]||(s[9]=U(" 类别 ",-1)),v(e("input",{"onUpdate:modelValue":s[2]||(s[2]=n=>o.value.category=n),placeholder:"credential/cloud/db/pii/endpoint..."},null,512),[[w,o.value.category]])]),e("label",null,[s[11]||(s[11]=U(" 严重级别 ",-1)),v(e("select",{"onUpdate:modelValue":s[3]||(s[3]=n=>o.value.severity=n)},[...s[10]||(s[10]=[e("option",{value:"critical"},"critical",-1),e("option",{value:"high"},"high",-1),e("option",{value:"medium"},"medium",-1),e("option",{value:"low"},"low",-1)])],512),[[ee,o.value.severity]])]),e("label",null,[s[12]||(s[12]=U(" 正则 flags ",-1)),v(e("input",{"onUpdate:modelValue":s[4]||(s[4]=n=>o.value.flags=n),placeholder:"g, gi 等"},null,512),[[w,o.value.flags]])]),e("label",Se,[s[13]||(s[13]=U(" 正则表达式 ",-1)),v(e("textarea",{"onUpdate:modelValue":s[5]||(s[5]=n=>o.value.pattern=n),rows:"3",placeholder:"请输入 JS 正则，不含外侧斜杠"},null,512),[[w,o.value.pattern]])]),e("label",Re,[s[14]||(s[14]=U(" 描述 ",-1)),v(e("textarea",{"onUpdate:modelValue":s[6]||(s[6]=n=>o.value.description=n),rows:"2"},null,512),[[w,o.value.description]])])]),e("div",{class:"editor-actions"},[e("button",{class:"primary",onClick:j},"保存"),e("button",{class:"ghost",onClick:T},"取消")]),u.value?(g(),f("p",Le,k(u.value),1)):I("",!0)])])):I("",!0)]))}}),De={class:"bl-card"},Te={class:"bl-head"},Ae={class:"bl-title"},je={key:0,class:"hint"},ze={key:0,class:"bl-actions"},Fe={class:"input-row"},Ne=["placeholder","onKeyup"],Oe=["disabled"],Ke={key:0,class:"chips"},qe=["onClick"],Pe={key:1,class:"hint"},L=q({__name:"ChipsListEditor",props:{modelValue:{},title:{},hint:{default:""},placeholder:{default:""},emptyHint:{default:"暂无数据"},addLabel:{default:"添加"},inputClass:{default:"mono"},dedupe:{type:Boolean,default:!0},normalize:{type:Function,default:void 0}},emits:["update:modelValue"],setup(i,{emit:l}){const d=i,b=l,a=h(""),B=J(()=>{const u=a.value??"";return((d.normalize?d.normalize(u):u.trim())??"").trim()});function m(){const u=B.value;if(!u)return;const y=d.dedupe?c([...d.modelValue??[],u]):[...d.modelValue??[],u];b("update:modelValue",y),a.value=""}function o(u){b("update:modelValue",(d.modelValue??[]).filter(y=>y!==u))}return(u,y)=>(g(),f("div",De,[e("div",Te,[e("div",null,[e("span",Ae,k(i.title),1),i.hint?(g(),f("small",je,k(i.hint),1)):I("",!0)]),u.$slots.actions?(g(),f("div",ze,[te(u.$slots,"actions")])):I("",!0)]),e("div",Fe,[v(e("input",{"onUpdate:modelValue":y[0]||(y[0]=x=>a.value=x),class:se(i.inputClass),type:"text",placeholder:i.placeholder,onKeyup:le(ne(m,["prevent"]),["enter"])},null,42,Ne),[[w,a.value]]),e("button",{class:"tiny",disabled:!a.value.trim(),onClick:m},k(i.addLabel),9,Oe)]),i.modelValue.length?(g(),f("div",Ke,[(g(!0),f(G,null,W(i.modelValue,x=>(g(),f("span",{key:x,class:"chip"},[U(k(x)+" ",1),e("button",{class:"chip-remove",onClick:E=>o(x),"aria-label":"移除"},"×",8,qe)]))),128))])):(g(),f("p",Pe,k(i.emptyHint),1))]))}}),Je={class:"options"},He={class:"panel"},Ge={class:"row"},We={class:"row"},Qe={class:"row"},Xe={class:"row"},Ye={class:"row"},Ze={class:"panel"},et={class:"blacklist-grid"},tt=["disabled"],lt=["disabled"],st={class:"panel"},nt={class:"blacklist-grid"},ot=["disabled"],at={class:"panel"},it={class:"blacklist-grid"},ut=["disabled"],dt={class:"actions"},rt=["disabled"],ct=["disabled"],pt={class:"status"},mt=q({__name:"Options",setup(i){const l=oe({includeInline:!0,maxContentSizeKB:5e3,requestTimeoutMs:2e4,scanTimeoutMs:3e3,autoScan:!1,outputBlacklist:[],fullUrlIgnoreExtensions:[],domainBlacklist:[],fileBlacklist:[]}),d=h(5),b=h(2e4),a=h(3e3),B=h(!1),m=h(""),o=h(!1);async function u(){const r=await re();Object.assign(l,r),l.outputBlacklist=c(l.outputBlacklist),l.fullUrlIgnoreExtensions=c(l.fullUrlIgnoreExtensions),l.domainBlacklist=c(l.domainBlacklist),l.fileBlacklist=c(l.fileBlacklist),d.value=Math.max(1,Math.round((r.maxContentSizeKB??5e3)/1024)),b.value=r.requestTimeoutMs??2e4,a.value=r.scanTimeoutMs??3e3}async function y(){B.value=!0,await ce({...l,maxContentSizeKB:d.value*1024,requestTimeoutMs:b.value,scanTimeoutMs:a.value,outputBlacklist:c(l.outputBlacklist),fullUrlIgnoreExtensions:c(l.fullUrlIgnoreExtensions),domainBlacklist:c(l.domainBlacklist),fileBlacklist:c(l.fileBlacklist)}),m.value="已保存",B.value=!1}async function x(){await chrome.runtime.sendMessage({type:"CLEAR_DATA"}),m.value="数据已清空"}async function E(){if(confirm("将删除扩展的 IndexedDB（扫描结果与脚本缓存）。此操作不可恢复，是否继续？")){o.value=!0;try{await pe(),m.value="IndexedDB 已清空"}catch(t){console.error("清空 IndexedDB 失败",t),m.value=`清空 IndexedDB 失败: ${t?.message??t}`}finally{o.value=!1}}}function M(){const r=c([...R.domainBlacklist??[]]),t=c([...l.domainBlacklist,...r]);l.domainBlacklist.splice(0,l.domainBlacklist.length,...t)}function D(){const r=c([...R.fileBlacklist??[]]),t=c([...l.fileBlacklist,...r]);l.fileBlacklist.splice(0,l.fileBlacklist.length,...t)}function T(){l.domainBlacklist.splice(0,l.domainBlacklist.length)}function A(){l.fileBlacklist.splice(0,l.fileBlacklist.length)}function j(){l.outputBlacklist.splice(0,l.outputBlacklist.length)}function z(){const r=c([...R.outputBlacklist??[]]),t=c([...l.outputBlacklist,...r]);l.outputBlacklist.splice(0,l.outputBlacklist.length,...t)}function $(){l.fullUrlIgnoreExtensions.splice(0,l.fullUrlIgnoreExtensions.length)}function F(){const r=c([...R.fullUrlIgnoreExtensions??[]]),t=c([...l.fullUrlIgnoreExtensions,...r]);l.fullUrlIgnoreExtensions.splice(0,l.fullUrlIgnoreExtensions.length,...t)}function N(r){m.value=r}return H(()=>{u()}),(r,t)=>(g(),f("main",Je,[t[21]||(t[21]=e("header",null,[e("h1",null,"ShadowSeek 设置"),e("p",{class:"sub"},"配置扫描策略与性能限制")],-1)),e("section",He,[t[14]||(t[14]=e("h2",null,"扫描策略",-1)),e("label",Ge,[v(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>l.includeInline=s),type:"checkbox"},null,512),[[K,l.includeInline]]),t[9]||(t[9]=e("span",null,"包含内联脚本",-1))]),e("label",We,[v(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>l.autoScan=s),type:"checkbox"},null,512),[[K,l.autoScan]]),t[10]||(t[10]=e("span",null,"自动扫描新标签页（完成加载后自动触发）",-1))]),e("label",Qe,[t[11]||(t[11]=e("span",null,"单文件最大体积 (MB)",-1)),v(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>d.value=s),type:"number",min:"1",step:"1"},null,512),[[w,d.value,void 0,{number:!0}]])]),e("label",Xe,[t[12]||(t[12]=e("span",null,"请求超时 (ms)",-1)),v(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>b.value=s),type:"number",min:"1000",step:"1000"},null,512),[[w,b.value,void 0,{number:!0}]])]),e("label",Ye,[t[13]||(t[13]=e("span",null,"正则分析超时 (ms)",-1)),v(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>a.value=s),type:"number",min:"500",step:"500"},null,512),[[w,a.value,void 0,{number:!0}]])])]),e("section",Ze,[t[15]||(t[15]=e("h2",null,"黑名单（命中即跳过扫描）",-1)),t[16]||(t[16]=e("p",{class:"sub"},"域名与文件名与内置规则一同生效，可用于加速或减少噪声。",-1)),e("div",et,[_(L,{modelValue:l.domainBlacklist,"onUpdate:modelValue":t[5]||(t[5]=s=>l.domainBlacklist=s),title:"域名黑名单",hint:"后缀匹配：输入 example.com 将匹配 example.com 与 *.example.com",placeholder:"输入域名后按回车添加，例如 google-analytics.com","empty-hint":"尚未添加域名，可添加常见统计/CDN 域名以减少噪声。"},{actions:S(()=>[e("button",{class:"tiny ghost",onClick:M},"添加推荐"),e("button",{class:"tiny ghost",disabled:!l.domainBlacklist.length,onClick:T},"清空",8,tt)]),_:1},8,["modelValue"]),_(L,{modelValue:l.fileBlacklist,"onUpdate:modelValue":t[6]||(t[6]=s=>l.fileBlacklist=s),title:"文件名/路径黑名单",hint:"包含匹配：路径中包含关键词即跳过，如 .map、/vendor、chunk-vendors",placeholder:"输入文件名/路径片段后回车添加，例如 .map /vendor","empty-hint":"尚未添加文件/路径，可添加 .map、chunk-vendors、react.production.min.js 等。"},{actions:S(()=>[e("button",{class:"tiny ghost",onClick:D},"添加推荐"),e("button",{class:"tiny ghost",disabled:!l.fileBlacklist.length,onClick:A},"清空",8,lt)]),_:1},8,["modelValue"])])]),e("section",st,[t[17]||(t[17]=e("h2",null,"输出黑名单（命中即忽略结果）",-1)),t[18]||(t[18]=e("p",{class:"sub"},[U("用于过滤常见噪声：匹配到的值将不保存/不展示。支持以 "),e("code",null,"*"),U(" 结尾的前缀匹配。")],-1)),e("div",nt,[_(L,{modelValue:l.outputBlacklist,"onUpdate:modelValue":t[7]||(t[7]=s=>l.outputBlacklist=s),title:"输出黑名单",hint:"包含匹配：如 /dist/、/node_modules/；前缀匹配：如 http://www.w3.org/*、text/*",placeholder:"输入要忽略的值/片段后回车添加，例如 text/* 或 http://www.w3.org/*","empty-hint":"尚未添加输出黑名单，可用于过滤 w3.org 命名空间、text/css 等噪声。"},{actions:S(()=>[e("button",{class:"tiny ghost",onClick:z},"添加推荐"),e("button",{class:"tiny ghost",disabled:!l.outputBlacklist.length,onClick:j},"清空",8,ot)]),_:1},8,["modelValue"])])]),e("section",at,[t[19]||(t[19]=e("h2",null,"完整 URL 静态后缀过滤",-1)),t[20]||(t[20]=e("p",{class:"sub"},"仅针对“完整 URL”结果：命中指定后缀（如 .js/.css）则忽略该 URL，用于减少静态资源噪声。",-1)),e("div",it,[_(L,{modelValue:l.fullUrlIgnoreExtensions,"onUpdate:modelValue":t[8]||(t[8]=s=>l.fullUrlIgnoreExtensions=s),title:"忽略的后缀列表",hint:"输入 .js 或 js 均可；匹配基于 URL 的 pathname（不含 query/hash）",placeholder:"输入扩展名后回车添加，例如 .js 或 css","empty-hint":"尚未添加后缀，可添加 .js/.css/.png 等减少“完整 URL”噪声。",normalize:Q(me)},{actions:S(()=>[e("button",{class:"tiny ghost",onClick:F},"添加推荐"),e("button",{class:"tiny ghost",disabled:!l.fullUrlIgnoreExtensions.length,onClick:$},"清空",8,ut)]),_:1},8,["modelValue","normalize"])])]),_(Me,{onStatus:N}),e("div",dt,[e("button",{class:"primary",disabled:B.value,onClick:y},k(B.value?"保存中...":"保存设置"),9,rt),e("button",{class:"ghost",onClick:x},"清空数据"),e("button",{class:"ghost",disabled:o.value,onClick:E},k(o.value?"清空中...":"清空 IndexedDB"),9,ct),e("span",pt,k(m.value),1)])]))}});ae(mt).mount("#app");
