import{d as L,c as p,o as u,a as d,t as g,b as G,n as oe,e as J,F as C,r as T,u as c,f as b,g as ie,h as A,i as re,j as ce,k as z,l as O,m as W,p as ue,q as de}from"./runtime-dom.esm-bundler.js";import{n as pe,i as Z,a as he,s as Q}from"./fullUrlFilter.js";const ve={class:"header"},ye={class:"actions"},fe=["disabled"],ge=["disabled"],me=["disabled"],_e=["disabled"],ke=L({__name:"PopupHeader",props:{loading:{type:Boolean},initializing:{type:Boolean},hasEndpointFindings:{type:Boolean},hasAnyFindings:{type:Boolean},hasFindings:{type:Boolean}},emits:["copyAll","export","scan","clear"],setup(e){return(n,a)=>(u(),p("header",ve,[a[4]||(a[4]=d("div",null,[d("h1",null,"ShadowSeek"),d("p",{class:"sub"},"扫描当前页面 JS，提取疑似敏感信息")],-1)),d("div",ye,[d("button",{class:"ghost",disabled:e.loading||!e.hasEndpointFindings,onClick:a[0]||(a[0]=o=>n.$emit("copyAll"))},"复制全部路径值",8,fe),d("button",{class:"ghost",disabled:e.loading||!e.hasAnyFindings,onClick:a[1]||(a[1]=o=>n.$emit("export"))},"导出结果",8,ge),d("button",{class:"primary",disabled:e.loading||e.initializing,onClick:a[2]||(a[2]=o=>n.$emit("scan"))},g(e.loading?"扫描中...":"扫描当前页"),9,me),d("button",{class:"ghost",disabled:e.loading||!e.hasFindings,onClick:a[3]||(a[3]=o=>n.$emit("clear"))},"清空结果",8,_e)])]))}}),$e={key:0,class:"progress-wrap"},be={class:"progress"},Se={class:"progress-info"},we={class:"progress-text"},Ae=["title"],Ce=L({__name:"ScanProgressBar",props:{processed:{},total:{},percent:{},currentScript:{},currentScriptShort:{}},setup(e){return(n,a)=>e.total>0?(u(),p("div",$e,[d("div",be,[d("div",{class:"bar",style:oe({width:e.percent+"%"})},null,4)]),d("div",Se,[d("span",we,g(e.processed)+" / "+g(e.total),1),e.currentScript?(u(),p("span",{key:0,class:"progress-script",title:e.currentScript},"当前："+g(e.currentScriptShort),9,Ae)):G("",!0)])])):G("",!0)}}),Ue={class:"segmented-wrap"},Ee={class:"segmented",role:"tablist","aria-label":"视图切换"},Be=["aria-pressed"],Le=["aria-pressed"],Ve=L({__name:"ViewModeSegmented",props:{modelValue:{}},emits:["update:modelValue"],setup(e){return(n,a)=>(u(),p("div",Ue,[d("div",Ee,[d("button",{type:"button",class:J(["segmented-btn",e.modelValue==="category"?"active":""]),"aria-pressed":e.modelValue==="category",onClick:a[0]||(a[0]=o=>n.$emit("update:modelValue","category"))}," 按类别汇总 ",10,Be),d("button",{type:"button",class:J(["segmented-btn",e.modelValue==="script"?"active":""]),"aria-pressed":e.modelValue==="script",onClick:a[1]||(a[1]=o=>n.$emit("update:modelValue","script"))}," 按脚本查看 ",10,Le)])]))}}),Fe={class:"group-head flat-head"},xe={class:"script"},Ie={class:"count"},Te={class:"flat-list"},Re={key:0,class:"flat-row empty-row"},Me={class:"item-left"},Pe=["data-kind"],Ne=["data-type"],ze=["title"],Oe=L({__name:"FindingsByCategory",props:{groups:{}},setup(e){return(n,a)=>(u(!0),p(C,null,T(e.groups,o=>(u(),p("div",{key:o.key,class:"group"},[d("div",Fe,[d("span",xe,g(o.title),1),d("span",Ie,g(o.values.length)+" 条",1)]),d("ul",Te,[o.values.length?(u(!0),p(C,{key:1},T(o.values,s=>(u(),p("li",{key:s,class:"flat-row"},[d("div",Me,[o.kind?(u(),p("span",{key:0,class:"badge kind","data-kind":o.kind},g(o.kind==="url"?"完整 URL":"路径"),9,Pe)):(u(),p("span",{key:1,class:"badge type","data-type":o.type??"info"},g(o.title),9,Ne)),d("span",{class:"value",title:s},g(s),9,ze)])]))),128)):(u(),p("li",Re,"—"))])]))),128))}}),Ge={api_key:"API Key/Token",credential:"凭据",cloud:"云凭据",endpoint:"接口/域名",pii:"PII",config:"配置",db:"数据库",vuln:"漏洞",info:"信息"};function ee(e){return Ge[e]??e}function je(e){try{const n=new URL(e);return`${n.hostname}${n.pathname}`}catch{return e}}function X(e){try{const n=new URL(e),a=n.pathname.split("/").pop()||n.pathname;return`${n.host}/${a}`}catch{return e}}function U(e){return(e.value??"").trim().replace(/^['"]+|['"]+$/g,"")}function Y(e){const n=U(e);return/^https?:\/\//i.test(n)?"url":"path"}const De={class:"group-head flat-head"},Ke={class:"script"},qe={class:"count"},He=["href"],Je={class:"flat-list"},We={key:0,class:"flat-row empty-row"},Qe={class:"item-left"},Xe=["data-kind"],Ye=["data-type"],Ze=["title"],et=L({__name:"FindingsByScript",props:{groups:{}},setup(e){return(n,a)=>(u(!0),p(C,null,T(e.groups,o=>(u(),p("div",{key:o.scriptUrl,class:"group"},[d("div",De,[d("span",Ke,g(c(je)(o.scriptUrl)),1),d("span",qe,g(o.items.length)+" 条",1),d("a",{class:"tiny link",href:o.scriptUrl,target:"_blank",rel:"noreferrer"},"打开",8,He)]),d("ul",Je,[o.items.length?(u(!0),p(C,{key:1},T(o.items,s=>(u(),p("li",{key:s.id,class:"flat-row"},[d("div",Qe,[s.type==="endpoint"?(u(),p("span",{key:0,class:"badge kind","data-kind":c(Y)(s)},g(c(Y)(s)==="url"?"完整 URL":"路径"),9,Xe)):(u(),p("span",{key:1,class:"badge type","data-type":s.type},g(c(ee)(s.type)),9,Ye)),d("span",{class:"value",title:c(U)(s)},g(c(U)(s)),9,Ze)])]))),128)):(u(),p("li",We,"—"))])]))),128))}});function tt(e,n,a="application/json"){const o=new Blob([e],{type:a}),s=URL.createObjectURL(o),r=document.createElement("a");r.href=s,r.download=n,r.click(),URL.revokeObjectURL(s)}function st(e){const n=new Map;for(const a of e)n.has(a.scriptUrl)||n.set(a.scriptUrl,[]),n.get(a.scriptUrl).push(a);return Array.from(n.entries()).map(([a,o])=>({scriptUrl:a,items:o.sort((s,r)=>r.createdAt-s.createdAt)})).sort((a,o)=>o.items.length-a.items.length)}function nt(e){const{findings:n,fullUrlIgnoreExtensions:a,isOutputBlacklistedValue:o}=e,s=new Map,r=pe(a);for(const h of n){const y=U(h);if(!y||o(y))continue;if(h.type==="endpoint"){const k=/^https?:\/\//i.test(y)?"url":"path";if(k==="url"&&Z(y,r))continue;const S=`endpoint:${k}`,V=k==="url"?"完整 URL":"路径";s.has(S)||s.set(S,{key:S,title:V,type:"endpoint",kind:k,values:[]}),s.get(S).values.push(y);continue}const w=`type:${h.type}`,E=ee(h.type);s.has(w)||s.set(w,{key:w,title:E,type:h.type,values:[]}),s.get(w).values.push(y)}const f=h=>Array.from(new Set(h)).sort((y,w)=>y.localeCompare(w)),v=s.get("endpoint:url"),m=s.get("endpoint:path");v&&(v.values=f(v.values)),m&&(m.values=f(m.values));const _=[];for(const h of s.values())h.key==="endpoint:url"||h.key==="endpoint:path"||(h.values=f(h.values),_.push(h));_.sort((h,y)=>h.title.localeCompare(y.title));const $=[];return v&&$.push(v),m&&$.push(m),$.push(..._),$}function at(){const e=b([]),n=b(!1),a=b(!0),o=b(!1),s=b(""),r=ie({processed:0,total:0}),f=b(null),v=b(null),m=b(null),_=b(null),$=b(null),h=b([]),y=b([]),w=b("category");function E(t){return he(t,h.value)}const k=A(()=>v.value?e.value.filter(t=>{try{return new URL(t.scriptUrl||t.url).host!==v.value?!1:!E(t.value)}catch{return!1}}):e.value),S=A(()=>k.value.length?k.value:e.value),V=A(()=>S.value.length>0),F=A(()=>(k.value.length?k.value:e.value).filter(t=>{if(t.type!=="endpoint")return!1;const l=U(t);return!(/^https?:\/\//i.test(l)&&Z(l,y.value))})),R=A(()=>F.value.length>0),j=A(()=>st(k.value)),x=A(()=>nt({findings:k.value,fullUrlIgnoreExtensions:y.value,isOutputBlacklistedValue:E})),M=A(()=>r.total<=0?0:Math.min(100,Math.round(r.processed/r.total*100))),te=A(()=>f.value?X(f.value):"");async function I(){o.value=!0;try{const t=await chrome.runtime.sendMessage({type:"GET_FINDINGS",host:v.value??void 0,limit:2e3});e.value=t.findings??[]}catch(t){console.error("获取结果失败",t),e.value=[]}finally{o.value=!1}}async function se(){const t=Array.from(new Set(F.value.map(l=>U(l)).filter(Boolean))).sort((l,i)=>l.localeCompare(i));if(!t.length){s.value="当前无接口/路径可复制";return}try{await navigator.clipboard.writeText(t.join(`
`)),s.value=`已复制 ${t.length} 条接口/路径`}catch(l){console.warn("复制失败",l)}}function ne(){if(!S.value.length){s.value="暂无可导出的结果";return}const t=x.value.map(i=>({key:i.key,title:i.title,kind:i.kind??null,type:i.type??null,values:i.values,total:i.values.length})),l={exportedAt:new Date().toISOString(),filtered:k.value.length>0,total:S.value.length,groups:t,items:S.value.map(i=>({id:i.id,type:i.type,rule:i.rule,value:U(i),url:i.url,scriptUrl:i.scriptUrl,createdAt:i.createdAt}))};tt(JSON.stringify(l,null,2),"shadowseek-findings.json"),s.value=`已导出 ${l.total} 条`}async function ae(){chrome.tabs.query({active:!0,currentWindow:!0},t=>{const l=t?.[0];if(_.value=l?.id??null,l?.url)try{const i=new URL(l.url);v.value=i.host,m.value=l.url,Q(l.url).then(N=>$.value=N)}catch{v.value=null}}),n.value=!0,r.processed=0,r.total=0,f.value=null,s.value="正在扫描当前页面...";try{const t=await chrome.runtime.sendMessage({type:"SCAN_ACTIVE_TAB"});s.value=t?.message??"扫描完成"}catch{s.value="启动扫描失败",n.value=!1}await I(),n.value=!1}async function le(){e.value=[],r.processed=0,r.total=0,f.value=null,n.value=!1,s.value="已清空";try{await chrome.runtime.sendMessage({type:"CLEAR_DATA",host:v.value??void 0,tabId:_.value??void 0})}catch{}}let B=0;async function D(t){try{const l=await chrome.tabs.get(t);if(_.value=t,l?.url){m.value=l.url;try{const i=new URL(l.url);v.value=i.host}catch{v.value=null}$.value=await Q(l.url);return}}catch{}m.value=null,v.value=null,$.value=null}async function P(t=!0){if(!_.value||!$.value)return;let l=null;try{l=(await chrome.storage.local.get($.value))?.[$.value]}catch(i){console.warn("Storage read failed",i)}l&&(n.value=!!l.loading,s.value=l.status??"",r.processed=l.processed??0,r.total=l.total??0,f.value=l.current??null);try{const i=await chrome.runtime.sendMessage({type:"GET_SCAN_STATE",tabId:_.value});i?.state&&(l=i.state,n.value=!!l.loading,s.value=l.status??"",r.processed=l.processed??0,r.total=l.total??0,f.value=l.current??null)}catch{}if(!l){t&&B<5?(B+=1,!n.value&&!e.value.length&&(s.value="正在获取进度..."),setTimeout(()=>P(B<5),600)):(e.value.length||(s.value="尚无扫描记录"),(B>=5||!t)&&(n.value=!1,B=0));return}B=0}const K=t=>{_.value!==t.tabId&&D(t.tabId).then(async()=>{await I(),await P()})},q=t=>{t?.tabId&&_.value&&t.tabId!==_.value||(t?.type==="SCAN_PROGRESS"&&(r.processed=t.processed??0,r.total=t.total??0,r.total>0&&(s.value=`扫描中 ${r.processed}/${r.total}`),f.value=t.current??null),t?.type==="SCAN_DONE"&&(n.value=!1,s.value=`扫描完成，处理 ${t.total} 个脚本`,f.value=null,r.processed=t.total??r.processed,r.total=t.total??r.total),t?.type==="SCAN_PARTIAL"&&(s.value=`扫描中：${t.script}，新增 ${t.added} 条`,I()))};return re(async()=>{try{const i=await chrome.runtime.sendMessage({type:"GET_SETTINGS"});h.value=i?.settings?.outputBlacklist??[],y.value=i?.settings?.fullUrlIgnoreExtensions??[]}catch{h.value=[],y.value=[]}const t=new Promise(i=>{chrome.tabs.query({active:!0,currentWindow:!0},async N=>{const H=N?.[0];H?.id&&await D(H.id),await I(),await P(!1),i()})}),l=new Promise(i=>setTimeout(i,1e3));try{await Promise.race([t,l])}catch(i){console.error("Init failed",i)}finally{a.value=!1}chrome.tabs.onActivated.addListener(K),chrome.runtime.onMessage.addListener(q)}),ce(()=>{try{chrome.tabs.onActivated.removeListener(K)}catch{}try{chrome.runtime.onMessage.removeListener(q)}catch{}}),{findings:e,loading:n,initializing:a,fetching:o,status:s,progress:r,currentScript:f,activeHost:v,activeUrl:m,viewMode:w,filteredFindings:k,groupedScripts:j,groupedCategories:x,endpointList:F,hasEndpointFindings:R,hasAnyFindings:V,progressPercent:M,currentScriptShort:te,shortScript:X,onCopyAll:se,onExport:ne,onScan:ae,onClear:le}}const lt={class:"popup"},ot={key:0,class:"status"},it={key:1,class:"status"},rt={key:2,class:"empty"},ct={key:3,class:"empty"},ut={key:4,class:"groups scripts"},dt=L({__name:"Popup",setup(e){const{findings:n,loading:a,initializing:o,fetching:s,status:r,progress:f,currentScript:v,viewMode:m,filteredFindings:_,groupedScripts:$,groupedCategories:h,hasEndpointFindings:y,hasAnyFindings:w,progressPercent:E,currentScriptShort:k,onCopyAll:S,onExport:V,onScan:F,onClear:R}=at();return(j,x)=>(u(),p("main",lt,[z(ke,{loading:c(a),initializing:c(o),"has-endpoint-findings":c(y),"has-any-findings":c(w),"has-findings":c(n).length>0,onCopyAll:c(S),onExport:c(V),onScan:c(F),onClear:c(R)},null,8,["loading","initializing","has-endpoint-findings","has-any-findings","has-findings","onCopyAll","onExport","onScan","onClear"]),c(r)?(u(),p("p",ot,g(c(r)),1)):c(_).length?(u(),p("p",it,"已找到 "+g(c(_).length)+" 条",1)):G("",!0),z(Ce,{processed:c(f).processed,total:c(f).total,percent:c(E),"current-script":c(v),"current-script-short":c(k)},null,8,["processed","total","percent","current-script","current-script-short"]),c(o)?(u(),p("section",rt,"正在初始化...")):c(n).length?(u(),p("section",ut,[z(Ve,{modelValue:c(m),"onUpdate:modelValue":x[0]||(x[0]=M=>ue(m)?m.value=M:null)},null,8,["modelValue"]),c(m)==="category"?(u(),W(Oe,{key:0,groups:c(h)},null,8,["groups"])):(u(),W(et,{key:1,groups:c($)},null,8,["groups"]))])):(u(),p("section",ct,[c(a)?(u(),p(C,{key:0},[O("正在分析...")],64)):c(s)?(u(),p(C,{key:1},[O("正在加载记录...")],64)):(u(),p(C,{key:2},[O("暂无数据，点击“扫描当前页”开始")],64))]))]))}});de(dt).mount("#app");
