import{d as re,r as p,a as ie,c as w,o as ce,b as n,e as o,f as a,g as F,t as c,n as ue,F as S,h as G,i as q,j as I,k as de}from"./runtime-dom.esm-bundler.js";import{i as pe,s as J}from"./outputBlacklist.js";const ve={class:"popup"},he={class:"header"},ye={class:"actions"},fe=["disabled"],_e=["disabled"],ke=["disabled"],me=["disabled"],ge={key:0,class:"status"},be={key:1,class:"status"},we={key:2,class:"progress-wrap"},Se={class:"progress"},Ae={class:"progress-info"},Ue={class:"progress-text"},Ce=["title"],Le={key:3,class:"empty"},Te={key:4,class:"empty"},Re={key:5,class:"groups scripts"},$e={class:"segmented-wrap"},Ie={class:"segmented",role:"tablist","aria-label":"视图切换"},Ee=["aria-pressed"],Me=["aria-pressed"],Ne={class:"group-head flat-head"},Pe={class:"script"},Be={class:"count"},xe={class:"flat-list"},Fe={key:0,class:"flat-row empty-row"},Ge={class:"item-left"},Oe=["data-kind"],Ve=["data-type"],je=["title"],De={class:"group-head flat-head"},ze={class:"script"},Ke={class:"count"},qe=["href"],Je={class:"flat-list"},We={key:0,class:"flat-row empty-row"},He={class:"item-left"},Qe=["data-kind"],Xe=["data-type"],Ye=["title"],Ze=re({__name:"Popup",setup(et){const v=p([]),u=p(!1),E=p(!0),M=p(!1),i=p(""),r=ie({processed:0,total:0}),y=p(null),k=p(null),N=p(null),m=p(null),A=p(null),P=p([]),b=p("category"),O=w(()=>(f.value.length?f.value:v.value).filter(s=>s.type==="endpoint")),W=w(()=>O.value.length>0),T=w(()=>f.value.length?f.value:v.value),H=w(()=>T.value.length>0),Q={api_key:"API Key/Token",credential:"凭据",cloud:"云凭据",endpoint:"接口/域名",pii:"PII",config:"配置",db:"数据库",vuln:"漏洞",info:"信息"};function V(s){return Q[s]??s}const f=w(()=>k.value?v.value.filter(s=>{try{return new URL(s.scriptUrl||s.url).host!==k.value?!1:!D(s.value)}catch{return!1}}):v.value),X=w(()=>{const s=new Map;for(const t of f.value)s.has(t.scriptUrl)||s.set(t.scriptUrl,[]),s.get(t.scriptUrl).push(t);return Array.from(s.entries()).map(([t,e])=>({scriptUrl:t,items:e.sort((l,h)=>h.createdAt-l.createdAt)})).sort((t,e)=>e.items.length-t.items.length)}),j=w(()=>{const s=new Map;for(const d of f.value){const _=U(d);if(!_||D(_))continue;if(d.type==="endpoint"){const x=/^https?:\/\//i.test(_)?"url":"path",$=`endpoint:${x}`,oe=x==="url"?"完整 URL":"路径";s.has($)||s.set($,{key:$,title:oe,type:"endpoint",kind:x,values:[]}),s.get($).values.push(_);continue}const L=`type:${d.type}`,ne=V(d.type);s.has(L)||s.set(L,{key:L,title:ne,type:d.type,values:[]}),s.get(L).values.push(_)}const t=d=>Array.from(new Set(d)).sort((_,L)=>_.localeCompare(L)),e=s.get("endpoint:url"),l=s.get("endpoint:path");e&&(e.values=t(e.values)),l&&(l.values=t(l.values));const h=[];for(const d of s.values())d.key==="endpoint:url"||d.key==="endpoint:path"||(d.values=t(d.values),h.push(d));h.sort((d,_)=>d.title.localeCompare(_.title));const g=[];return e&&g.push(e),l&&g.push(l),g.push(...h),g});function Y(s){try{const t=new URL(s);return`${t.hostname}${t.pathname}`}catch{return s}}function U(s){return(s.value??"").trim().replace(/^['"]+|['"]+$/g,"")}function D(s){return pe(s,P.value)}function z(s){const t=U(s);return/^https?:\/\//i.test(t)?"url":"path"}async function Z(){const s=Array.from(new Set(O.value.map(t=>U(t)).filter(Boolean))).sort((t,e)=>t.localeCompare(e));if(!s.length){i.value="当前无接口/路径可复制";return}try{await navigator.clipboard.writeText(s.join(`
`)),i.value=`已复制 ${s.length} 条接口/路径`}catch(t){console.warn("复制失败",t)}}function ee(s,t,e="application/json"){const l=new Blob([s],{type:e}),h=URL.createObjectURL(l),g=document.createElement("a");g.href=h,g.download=t,g.click(),URL.revokeObjectURL(h)}function te(){if(!T.value.length){i.value="暂无可导出的结果";return}const s=j.value.map(e=>({key:e.key,title:e.title,kind:e.kind??null,type:e.type??null,values:e.values,total:e.values.length})),t={exportedAt:new Date().toISOString(),filtered:f.value.length>0,total:T.value.length,groups:s,items:T.value.map(e=>({id:e.id,type:e.type,rule:e.rule,value:U(e),url:e.url,scriptUrl:e.scriptUrl,createdAt:e.createdAt}))};ee(JSON.stringify(t,null,2),"shadowseek-findings.json"),i.value=`已导出 ${t.total} 条`}async function R(){M.value=!0;try{const s=await chrome.runtime.sendMessage({type:"GET_FINDINGS",limit:2e3});v.value=s.findings??[]}catch(s){console.error("获取结果失败",s),v.value=[]}finally{M.value=!1}}async function se(){chrome.tabs.query({active:!0,currentWindow:!0},s=>{const t=s?.[0];if(m.value=t?.id??null,t?.url)try{const e=new URL(t.url);k.value=e.host,N.value=t.url,J(t.url).then(l=>A.value=l)}catch{k.value=null}}),u.value=!0,r.processed=0,r.total=0,y.value=null,i.value="正在扫描当前页面...";try{const s=await chrome.runtime.sendMessage({type:"SCAN_ACTIVE_TAB"});i.value=s?.message??"扫描完成"}catch{i.value="启动扫描失败",u.value=!1}await R(),u.value=!1}async function ae(){v.value=[],r.processed=0,r.total=0,y.value=null,u.value=!1,i.value="已清空";try{await chrome.runtime.sendMessage({type:"CLEAR_DATA",host:k.value??void 0,tabId:m.value??void 0})}catch{}}let C=0;async function K(s){try{const t=await chrome.tabs.get(s);if(m.value=s,t?.url){N.value=t.url;try{const e=new URL(t.url);k.value=e.host}catch{k.value=null}A.value=await J(t.url);return}}catch{}N.value=null,k.value=null,A.value=null}async function B(s=!0){if(!m.value||!A.value)return;let t=null;try{t=(await chrome.storage.local.get(A.value))?.[A.value]}catch(e){console.warn("Storage read failed",e)}t&&(u.value=!!t.loading,i.value=t.status??"",r.processed=t.processed??0,r.total=t.total??0,y.value=t.current??null);try{const e=await chrome.runtime.sendMessage({type:"GET_SCAN_STATE",tabId:m.value});e?.state&&(t=e.state,u.value=!!t.loading,i.value=t.status??"",r.processed=t.processed??0,r.total=t.total??0,y.value=t.current??null)}catch{}if(!t){s&&C<5?(C+=1,!u.value&&!v.value.length&&(i.value="正在获取进度..."),setTimeout(()=>B(C<5),600)):(v.value.length||(i.value="尚无扫描记录"),(C>=5||!s)&&(u.value=!1,C=0));return}C=0}ce(async()=>{try{const e=await chrome.runtime.sendMessage({type:"GET_SETTINGS"});P.value=e?.settings?.outputBlacklist??[]}catch{P.value=[]}R();const s=new Promise(e=>{chrome.tabs.query({active:!0,currentWindow:!0},async l=>{const h=l?.[0];h?.id&&await K(h.id),await B(!1),e()})}),t=new Promise(e=>setTimeout(e,1e3));try{await Promise.race([s,t])}catch(e){console.error("Init failed",e)}finally{E.value=!1}chrome.tabs.onActivated.addListener(e=>{m.value!==e.tabId&&(K(e.tabId).then(()=>B()),R())}),chrome.runtime.onMessage.addListener(e=>{e?.tabId&&m.value&&e.tabId!==m.value||(e?.type==="SCAN_PROGRESS"&&(r.processed=e.processed??0,r.total=e.total??0,r.total>0&&(i.value=`扫描中 ${r.processed}/${r.total}`),y.value=e.current??null),e?.type==="SCAN_DONE"&&(u.value=!1,i.value=`扫描完成，处理 ${e.total} 个脚本`,y.value=null,r.processed=e.total??r.processed,r.total=e.total??r.total),e?.type==="SCAN_PARTIAL"&&(i.value=`扫描中：${e.script}，新增 ${e.added} 条`,R()))})});function le(s){try{const t=new URL(s),e=t.pathname.split("/").pop()||t.pathname;return`${t.host}/${e}`}catch{return s}}return(s,t)=>(o(),n("main",ve,[a("header",he,[t[2]||(t[2]=a("div",null,[a("h1",null,"ShadowSeek"),a("p",{class:"sub"},"扫描当前页面 JS，提取疑似敏感信息")],-1)),a("div",ye,[a("button",{class:"ghost",disabled:u.value||!W.value,onClick:Z}," 复制全部路径值 ",8,fe),a("button",{class:"ghost",disabled:u.value||!H.value,onClick:te}," 导出结果 ",8,_e),a("button",{class:"primary",disabled:u.value||E.value,onClick:se},c(u.value?"扫描中...":"扫描当前页"),9,ke),a("button",{class:"ghost",disabled:u.value||!v.value.length,onClick:ae},"清空结果",8,me)])]),i.value?(o(),n("p",ge,c(i.value),1)):f.value.length?(o(),n("p",be,"已找到 "+c(f.value.length)+" 条",1)):F("",!0),r.total>0?(o(),n("div",we,[a("div",Se,[a("div",{class:"bar",style:ue({width:Math.min(100,Math.round(r.processed/r.total*100))+"%"})},null,4)]),a("div",Ae,[a("span",Ue,c(r.processed)+" / "+c(r.total),1),y.value?(o(),n("span",{key:0,class:"progress-script",title:y.value},"当前："+c(le(y.value)),9,Ce)):F("",!0)])])):F("",!0),E.value?(o(),n("section",Le,"正在初始化...")):v.value.length?(o(),n("section",Re,[a("div",$e,[a("div",Ie,[a("button",{type:"button",class:q(["segmented-btn",b.value==="category"?"active":""]),"aria-pressed":b.value==="category",onClick:t[0]||(t[0]=e=>b.value="category")}," 按类别汇总 ",10,Ee),a("button",{type:"button",class:q(["segmented-btn",b.value==="script"?"active":""]),"aria-pressed":b.value==="script",onClick:t[1]||(t[1]=e=>b.value="script")}," 按脚本查看 ",10,Me)])]),b.value==="category"?(o(!0),n(S,{key:0},I(j.value,e=>(o(),n("div",{key:e.key,class:"group"},[a("div",Ne,[a("span",Pe,c(e.title),1),a("span",Be,c(e.values.length)+" 条",1)]),a("ul",xe,[e.values.length?(o(!0),n(S,{key:1},I(e.values,l=>(o(),n("li",{key:l,class:"flat-row"},[a("div",Ge,[e.kind?(o(),n("span",{key:0,class:"badge kind","data-kind":e.kind},c(e.kind==="url"?"完整 URL":"路径"),9,Oe)):(o(),n("span",{key:1,class:"badge type","data-type":e.type??"info"},c(e.title),9,Ve)),a("span",{class:"value",title:l},c(l),9,je)])]))),128)):(o(),n("li",Fe,"—"))])]))),128)):(o(!0),n(S,{key:1},I(X.value,e=>(o(),n("div",{key:e.scriptUrl,class:"group"},[a("div",De,[a("span",ze,c(Y(e.scriptUrl)),1),a("span",Ke,c(e.items.length)+" 条",1),a("a",{class:"tiny link",href:e.scriptUrl,target:"_blank",rel:"noreferrer"},"打开",8,qe)]),a("ul",Je,[e.items.length?(o(!0),n(S,{key:1},I(e.items,l=>(o(),n("li",{key:l.id,class:"flat-row"},[a("div",He,[l.type==="endpoint"?(o(),n("span",{key:0,class:"badge kind","data-kind":z(l)},c(z(l)==="url"?"完整 URL":"路径"),9,Qe)):(o(),n("span",{key:1,class:"badge type","data-type":l.type},c(V(l.type)),9,Xe)),a("span",{class:"value",title:U(l)},c(U(l)),9,Ye)])]))),128)):(o(),n("li",We,"—"))])]))),128))])):(o(),n("section",Te,[u.value?(o(),n(S,{key:0},[G("正在分析...")],64)):M.value?(o(),n(S,{key:1},[G("正在加载记录...")],64)):(o(),n(S,{key:2},[G("暂无数据，点击“扫描当前页”开始")],64))]))]))}});de(Ze).mount("#app");
