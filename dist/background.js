import{h as D,n as ot,s as R,i as G}from"./assets/outputBlacklist.js";import{s as at,l as F,c as it}from"./assets/rulesStore.js";const W=60,ct=5e3;function ut(t,e,n){const s=Math.max(0,e-W),o=Math.min(t.length,e+n+W);return t.slice(s,o).replace(/\s+/g," ").trim()}async function lt(t,e,n,s=3e3,o){const r=[],a=new Set,u=Date.now(),c=s<=0?Number.POSITIVE_INFINITY:s,d=[...n].sort((w,y)=>{const m=w.id.startsWith("find-")?0:1,g=y.id.startsWith("find-")?0:1;return m!==g?m-g:0});for(const w of d){if(Date.now()-u>c){console.warn(`[ShadowSeek] 扫描超时 (${c}ms), 已停止: ${e}`);break}const y=w.regexp;y.lastIndex=0;let m,g=0;const b=2e4;try{for(;(m=y.exec(t))!==null&&(g++,!(g>b));){if(g%50===0){if(Date.now()-u>c){console.warn(`[ShadowSeek] 正则执行中超时, 强制停止: ${e}`);const l=await D(`${e}:${t.slice(0,2048)}`);return{findings:r,contentHash:l,size:t.length}}await new Promise(l=>setTimeout(l,0))}const f=m[0];if(!f)break;const h=ot(f);if(!h||o&&!o(h))continue;const S=ut(t,m.index,h.length),i=await D(`${w.id}:${e}:${m.index}:${h}`);if(!a.has(i)&&(a.add(i),r.push({id:i,type:w.category||"info",rule:w.id,value:h.slice(0,256),context:S.slice(0,512),url:e,scriptUrl:e,createdAt:Date.now()}),r.length>=ct))break}}catch(f){console.warn(`[ShadowSeek] 正则匹配出错: ${w.id} on ${e}`,f)}}const k=await D(`${e}:${t.slice(0,2048)}`);return{findings:r,contentHash:k,size:t.length}}const N=(t,e)=>e.some(n=>t instanceof n);let z,H;function dt(){return z||(z=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ft(){return H||(H=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const v=new WeakMap,M=new WeakMap,x=new WeakMap;function ht(t){const e=new Promise((n,s)=>{const o=()=>{t.removeEventListener("success",r),t.removeEventListener("error",a)},r=()=>{n(T(t.result)),o()},a=()=>{s(t.error),o()};t.addEventListener("success",r),t.addEventListener("error",a)});return x.set(e,t),e}function wt(t){if(v.has(t))return;const e=new Promise((n,s)=>{const o=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",a),t.removeEventListener("abort",a)},r=()=>{n(),o()},a=()=>{s(t.error||new DOMException("AbortError","AbortError")),o()};t.addEventListener("complete",r),t.addEventListener("error",a),t.addEventListener("abort",a)});v.set(t,e)}let $={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return v.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return T(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function Z(t){$=t($)}function mt(t){return ft().includes(t)?function(...e){return t.apply(O(this),e),T(this.request)}:function(...e){return T(t.apply(O(this),e))}}function pt(t){return typeof t=="function"?mt(t):(t instanceof IDBTransaction&&wt(t),N(t,dt())?new Proxy(t,$):t)}function T(t){if(t instanceof IDBRequest)return ht(t);if(M.has(t))return M.get(t);const e=pt(t);return e!==t&&(M.set(t,e),x.set(e,t)),e}const O=t=>x.get(t);function gt(t,e,{blocked:n,upgrade:s,blocking:o,terminated:r}={}){const a=indexedDB.open(t,e),u=T(a);return s&&a.addEventListener("upgradeneeded",c=>{s(T(a.result),c.oldVersion,c.newVersion,T(a.transaction),c)}),n&&a.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),u.then(c=>{r&&c.addEventListener("close",()=>r()),o&&c.addEventListener("versionchange",d=>o(d.oldVersion,d.newVersion,d))}).catch(()=>{}),u}const yt=["get","getKey","getAll","getAllKeys","count"],Tt=["put","add","delete","clear"],_=new Map;function X(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(_.get(e))return _.get(e);const n=e.replace(/FromIndex$/,""),s=e!==n,o=Tt.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(o||yt.includes(n)))return;const r=async function(a,...u){const c=this.transaction(a,o?"readwrite":"readonly");let d=c.store;return s&&(d=d.index(u.shift())),(await Promise.all([d[n](...u),o&&c.done]))[0]};return _.set(e,r),r}Z(t=>({...t,get:(e,n,s)=>X(e,n)||t.get(e,n,s),has:(e,n)=>!!X(e,n)||t.has(e,n)}));const St=["continue","continuePrimaryKey","advance"],q={},j=new WeakMap,tt=new WeakMap,bt={get(t,e){if(!St.includes(e))return t[e];let n=q[e];return n||(n=q[e]=function(...s){j.set(this,tt.get(this)[e](...s))}),n}};async function*It(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,bt);for(tt.set(n,e),x.set(n,O(e));e;)yield n,e=await(j.get(n)||e.continue()),j.delete(n)}function K(t,e){return e===Symbol.asyncIterator&&N(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&N(t,[IDBIndex,IDBObjectStore])}Z(t=>({...t,get(e,n,s){return K(e,n)?It:t.get(e,n,s)},has(e,n){return K(e,n)||t.has(e,n)}}));const At="shadowseek-db",Et=1;let P=null;function E(){return P||(P=gt(At,Et,{upgrade(t){const e=t.createObjectStore("findings",{keyPath:"id"});e.createIndex("by-created","createdAt"),e.createIndex("by-type","type"),t.createObjectStore("scripts",{keyPath:"id"}).createIndex("by-url","url")}})),P}async function Y(t){if(!t.length)return 0;const n=(await E()).transaction("findings","readwrite");for(const s of t)await n.store.put(s);return await n.done,t.length}async function Ct(t=50,e=0){let r=await(await E()).transaction("findings").store.index("by-created").openCursor(null,"prev");const a=[];let u=0;for(;r&&a.length<t;)u<e?u+=1:a.push(r.value),r=await r.continue();return a}async function Dt(t){const n=(await E()).transaction("scripts","readwrite");await n.store.put(t),await n.done}async function xt(){const t=await E();await Promise.all([t.clear("findings"),t.clear("scripts")])}async function kt(t){const n=(await E()).transaction(["findings","scripts"],"readwrite");let s=await n.objectStore("findings").openCursor();for(;s;){const r=s.value;[r.url,r.scriptUrl].filter(Boolean).some(c=>{try{return new URL(c).host===t}catch{return!1}})&&await s.delete(),s=await s.continue()}let o=await n.objectStore("scripts").openCursor();for(;o;){const r=o.value;try{new URL(r.url).host===t&&await o.delete()}catch{}o=await o.continue()}await n.done}const Lt=[/\/(?:node_modules|vendor|third-party|3rdparty)\//i,/(?:jquery|react|vue|angular|bootstrap|moment|lodash)(?:\.min)?\.js/i,/(?:cdnjs\.|unpkg\.com|jsdelivr\.net|googleapis\.com|gstatic\.com|cloudflare\.com)/i,/\.map($|\?)/i],J=200,Mt=new Set([".js",".mjs",".cjs",".json",".css",".html",".htm",".txt",".xml",".yml",".yaml",".conf",".config",".ini",".env",".properties",".php",".jsp",".asp",".aspx"]);function B(t,e){if(!t)return!1;const n=t.toLowerCase();if(Lt.some(r=>r.test(t)))return!0;const s=e.domainBlacklist??[],o=e.fileBlacklist??[];try{const r=new URL(t),a=r.hostname.toLowerCase();if(s.some(c=>a===c.toLowerCase()||a.endsWith(`.${c.toLowerCase()}`)))return!0;const u=`${r.pathname}${r.search}`.toLowerCase();if(o.some(c=>u.includes(c.toLowerCase())))return!0}catch{if(s.some(r=>n.includes(r.toLowerCase()))||o.some(r=>n.includes(r.toLowerCase())))return!0}return!1}function _t(t){try{const e=new URL(t),n=e.pathname.toLowerCase(),s=n.split("/").pop()??"",o=s.lastIndexOf(".");if(o>0){const r=s.slice(o);return Mt.has(r)}return/\/(api|graphql|rpc|rest|v\d+|swagger|openapi|ws)\b/i.test(n)||/[?&](token|key|secret|auth|access_token)=/i.test(e.search)}catch{return!1}}const I=new Map,A=new Map,Q=120*1e3,U=1800*1e3;async function p(t,e){const s={...A.get(t)||{processed:0,total:0,current:null,status:"",loading:!1,updatedAt:Date.now()},...e,updatedAt:Date.now()};A.set(t,s),await chrome.storage.local.set({[t]:s})}async function et(t){const e=A.get(t);if(e){const a=e.noTimeout?U:Q;if(e.loading&&Date.now()-e.updatedAt>a){const u={...e,loading:!1,status:e.status||"扫描中断或超时"};return await p(t,u),u}return e}const s=(await chrome.storage.local.get(t))?.[t];if(!s)return null;const o={processed:s.processed??0,total:s.total??0,current:s.current??null,status:s.status??"",loading:!!s.loading,updatedAt:s.updatedAt??Date.now(),pageUrl:s.pageUrl,noTimeout:s.noTimeout},r=o.noTimeout?U:Q;if(o.loading&&Date.now()-o.updatedAt>r){const a={...o,loading:!1,status:o.status||"扫描中断或超时"};return await p(t,a),a}return A.set(t,o),o}chrome.runtime.onInstalled.addListener(()=>{console.log("ShadowSeek 扩展已安装，等待扫描命令。")});chrome.runtime.onMessage.addListener((t,e,n)=>(Pt(t).then(s=>n(s)).catch(s=>{console.error("消息处理失败",s),n({ok:!1,message:s?.message??"处理失败"})}),!0));async function Pt(t){switch(t.type){case"SCAN_ACTIVE_TAB":return Bt();case"GET_FINDINGS":return{ok:!0,findings:await Ct(t.limit??50,t.offset??0)};case"CLEAR_DATA":if(t.host?await kt(t.host):await xt(),t.tabId)try{const e=await chrome.tabs.get(t.tabId);if(e?.url){const n=await R(e.url);A.delete(n),await chrome.storage.local.remove(n)}}catch{}return{ok:!0};case"GET_SETTINGS":return{ok:!0,settings:await F()};case"SAVE_SETTINGS":return{ok:!0,settings:await at(t.settings)};case"GET_SCAN_STATE":try{const e=await chrome.tabs.get(t.tabId);if(!e?.url)return{ok:!0,state:null};const n=await R(e.url),s=await et(n);return{ok:!0,state:s?{...s}:null}}catch{return{ok:!0,state:null}}default:return{ok:!1,message:"未知指令"}}}async function Bt(){const t=await F(),[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return!e?.id||!e.url?{ok:!1,message:"未找到可扫描的标签页"}:nt(e.id,e.url,t)}chrome.tabs.onUpdated.addListener(async(t,e,n)=>{if(e.status!=="complete")return;const s=await F();s.autoScan&&(!n.url||!n.url.startsWith("http")||await nt(t,n.url,s))});async function nt(t,e,n){const s=Date.now(),o=`${t}|${e}`,r=I.get(o);if(r&&s-r<6e4)return{ok:!1,message:"该标签页正在扫描，请稍后重试"};I.set(o,s);const a=await R(e);await p(a,{processed:0,total:0,current:null,status:"正在扫描",loading:!0,pageUrl:e,noTimeout:!!n.disableTimeouts});const u=await it();if(!u.length)return I.delete(o),await p(a,{processed:0,total:0,current:null,status:"未启用任何规则",loading:!1,pageUrl:e,noTimeout:!!n.disableTimeouts}),{ok:!1,message:"未启用任何规则，请在规则管理中开启后重试"};const{scripts:c,endpoints:d,documents:k,targets:w}=await Rt(t,n.includeInline),y=c.filter(i=>!B(i.url,n)),m=(k??[]).filter(i=>!!i.content),g=new Set(y.map(i=>i.url)),b=[];for(const i of(w??[]).slice(0,J*5))if(i&&!g.has(i)&&!B(i,n)&&_t(i)&&(b.push({url:i,inline:!1}),b.length>=J))break;const f=[...m,...y,...b];if(!f.length)return I.delete(o),await p(a,{processed:0,total:0,current:null,status:"未获取到脚本",loading:!1,pageUrl:e,noTimeout:!!n.disableTimeouts}),{ok:!1,message:"未获取到可扫描内容"};let h=0;chrome.runtime.sendMessage({type:"SCAN_PROGRESS",processed:0,total:f.length,tabId:t}),await p(a,{processed:0,total:f.length,current:null,status:"正在扫描",loading:!0,pageUrl:e,noTimeout:!!n.disableTimeouts});let S=0;try{for(const i of f){try{const l=await Nt(i,n,e);if(!l)continue;const{findings:L,contentHash:V,size:st}=await lt(l,i.url,u,n.disableTimeouts?0:n.scanTimeoutMs,rt=>!G(rt,n.outputBlacklist)),C=L;C.length&&(h+=C.length,await Y(C),chrome.runtime.sendMessage({type:"SCAN_PARTIAL",script:i.url,added:C.length,tabId:t})),await Dt({id:V,url:i.url,inline:i.inline,contentHash:V,size:st,fetchedAt:Date.now()})}catch(l){console.warn("资源处理失败",i.url,l)}S+=1,await p(a,{processed:S,total:f.length,current:i.url,status:`扫描中 ${S}/${f.length}`,loading:!0,pageUrl:e,noTimeout:!!n.disableTimeouts}),chrome.runtime.sendMessage({type:"SCAN_PROGRESS",processed:S,total:f.length,current:i.url,tabId:t})}if(d?.length){const i=[];for(const l of d){if(!l.url||B(l.url,n)||G(l.url,n.outputBlacklist))continue;const L=await D(`runtime-endpoint:${l.url}`);i.push({id:L,type:"endpoint",rule:"runtime-endpoint",value:l.url,context:l.method?l.method:"",url:l.url,scriptUrl:l.url,createdAt:Date.now()})}i.length&&(h+=i.length,await Y(i),chrome.runtime.sendMessage({type:"SCAN_PARTIAL",script:"runtime-endpoints",added:i.length,tabId:t}))}return await p(a,{processed:f.length,total:f.length,current:null,status:`扫描完成，处理 ${f.length} 个资源`,loading:!1,pageUrl:e,noTimeout:!!n.disableTimeouts}),chrome.runtime.sendMessage({type:"SCAN_DONE",total:f.length,findings:h,tabId:t}),{ok:!0,message:`扫描完成，发现 ${h} 条疑似敏感信息`}}finally{I.delete(o);const i=await et(a);i?.loading&&await p(a,{...i,loading:!1,status:i.status||"扫描中断或超时",pageUrl:e,noTimeout:!!n.disableTimeouts})}}async function Rt(t,e){try{const n=await chrome.tabs.sendMessage(t,{type:"COLLECT_SCRIPTS",includeInline:e});return{scripts:n?.scripts??[],endpoints:n?.endpoints??[],documents:n?.documents??[],targets:n?.targets??[]}}catch(n){return console.error("向 content script 请求脚本失败",n),{scripts:[],endpoints:[],documents:[],targets:[]}}}async function Nt(t,e,n){if(t.inline)return t.content??"";if(!t.url)return"";const s=new AbortController,r=!e.disableTimeouts&&e.requestTimeoutMs>0?setTimeout(()=>s.abort(),e.requestTimeoutMs):null;let a="omit";try{if(n){const u=new URL(n).origin,c=new URL(t.url).origin;u===c&&(a="include")}}catch{}try{const u=await fetch(t.url,{method:"GET",credentials:a,mode:"cors",signal:s.signal});if(!u.ok)return console.warn("拉取脚本失败",t.url,u.status),"";const c=await u.text(),d=c.length/1024;return d>e.maxContentSizeKB?(console.warn("脚本超出大小限制，已跳过",t.url,d),""):c}catch(u){return console.warn("获取脚本内容异常",t.url,u),""}finally{r&&clearTimeout(r)}}
