import{c as V,e as D,f as X,a as x,b as q,h as W,i as Y,j as U,k as J}from"./assets/rulesStore.js";import{s as N,h as L,b as K,a as P,i as Q}from"./assets/fullUrlFilter.js";const S=new Map,_=new Set;let E=null;const Z=200,v=120*1e3,F=1800*1e3;async function G(){if(!_.size)return;const t={};for(const e of _){const n=S.get(e);n&&(t[e]=n)}_.clear(),E&&(clearTimeout(E),E=null),await chrome.storage.local.set(t)}function tt(){E||(E=setTimeout(()=>{G().catch(t=>console.warn("[ShadowSeek] flush progress failed",t))},Z))}async function f(t,e,n){const a={...S.get(t)||{processed:0,total:0,current:null,status:"",loading:!1,updatedAt:Date.now()},...e,updatedAt:Date.now()};S.set(t,a),_.add(t),n?.flush?await G():tt()}async function j(t){const e=S.get(t);if(e){const i=e.noTimeout?F:v;if(e.loading&&Date.now()-e.updatedAt>i){const c={...e,loading:!1,status:e.status||"扫描中断或超时"};return await f(t,c,{flush:!0}),c}return e}const s=(await chrome.storage.local.get(t))?.[t];if(!s)return null;const a={processed:s.processed??0,total:s.total??0,current:s.current??null,status:s.status??"",loading:!!s.loading,updatedAt:s.updatedAt??Date.now(),pageUrl:s.pageUrl,noTimeout:s.noTimeout},r=a.noTimeout?F:v;if(a.loading&&Date.now()-a.updatedAt>r){const i={...a,loading:!1,status:a.status||"扫描中断或超时"};return await f(t,i,{flush:!0}),i}return S.set(t,a),a}async function et(t){const e=await N(t);S.delete(e),_.delete(e),await chrome.storage.local.remove(e)}const O=60,nt=5e3,st=2e4,ot=50;function at(t,e,n){const s=Math.max(0,e-O),a=Math.min(t.length,e+n+O);return t.slice(s,a).replace(/\s+/g," ").trim()}function rt(t){return[...t].sort((e,n)=>{const s=e.id.startsWith("find-")?0:1,a=n.id.startsWith("find-")?0:1;return s!==a?s-a:0})}async function it(t,e,n,s=3e3,a){const r=[],i=new Set,c=Date.now(),l=s<=0?Number.POSITIVE_INFINITY:s,w=rt(n);for(const p of w){if(Date.now()-c>l){console.warn(`[ShadowSeek] 扫描超时 (${l}ms), 已停止: ${e}`);break}const y=p.regexp;y.lastIndex=0;let g,A=0;try{for(;(g=y.exec(t))!==null&&(A++,!(A>st));){if(A%ot===0){if(Date.now()-c>l){console.warn(`[ShadowSeek] 正则执行中超时, 强制停止: ${e}`);const o=await L(`${e}:${t.slice(0,2048)}`);return{findings:r,contentHash:o,size:t.length}}await new Promise(o=>setTimeout(o,0))}const h=g[0];if(!h)break;const u=K(h);if(!u||a&&!a(u))continue;const T=at(t,g.index,u.length),m=await L(`${p.id}:${e}:${g.index}:${u}`);if(!i.has(m)&&(i.add(m),r.push({id:m,type:p.category||"info",rule:p.id,value:u.slice(0,256),context:T.slice(0,512),url:e,scriptUrl:e,createdAt:Date.now()}),r.length>=nt))break}}catch(h){console.warn(`[ShadowSeek] 正则匹配出错: ${p.id} on ${e}`,h)}}const R=await L(`${e}:${t.slice(0,2048)}`);return{findings:r,contentHash:R,size:t.length}}const ct=[/\/(?:node_modules|vendor|third-party|3rdparty)\//i,/(?:jquery|react|vue|angular|bootstrap|moment|lodash)(?:\.min)?\.js/i,/(?:cdnjs\.|unpkg\.com|jsdelivr\.net|googleapis\.com|gstatic\.com|cloudflare\.com)/i,/\.map($|\?)/i],B=200,ut=new Set([".js",".mjs",".cjs",".json",".css",".html",".htm",".txt",".xml",".yml",".yaml",".conf",".config",".ini",".env",".properties",".php",".jsp",".asp",".aspx"]);function I(t,e){if(!t)return!1;const n=t.toLowerCase();if(ct.some(r=>r.test(t)))return!0;const s=e.domainBlacklist??[],a=e.fileBlacklist??[];try{const r=new URL(t),i=r.hostname.toLowerCase();if(s.some(l=>i===l.toLowerCase()||i.endsWith(`.${l.toLowerCase()}`)))return!0;const c=`${r.pathname}${r.search}`.toLowerCase();if(a.some(l=>c.includes(l.toLowerCase())))return!0}catch{if(s.some(r=>n.includes(r.toLowerCase()))||a.some(r=>n.includes(r.toLowerCase())))return!0}return!1}function lt(t){try{const e=new URL(t),n=e.pathname.toLowerCase(),s=n.split("/").pop()??"",a=s.lastIndexOf(".");if(a>0){const r=s.slice(a);return ut.has(r)}return/\/(api|graphql|rpc|rest|v\d+|swagger|openapi|ws)\b/i.test(n)||/[?&](token|key|secret|auth|access_token)=/i.test(e.search)}catch{return!1}}const k=new Map;async function dt(){const t=await x(),[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return!e?.id||!e.url?{ok:!1,message:"未找到可扫描的标签页"}:H(e.id,e.url,t)}async function H(t,e,n){const s=Date.now(),a=`${t}|${e}`,r=k.get(a);if(r&&s-r<6e4)return{ok:!1,message:"该标签页正在扫描，请稍后重试"};k.set(a,s);const i=await N(e);await f(i,{processed:0,total:0,current:null,status:"正在扫描",loading:!0,pageUrl:e,noTimeout:!!n.disableTimeouts},{flush:!0});const c=await V();if(!c.length)return k.delete(a),await f(i,{processed:0,total:0,current:null,status:"未启用任何规则",loading:!1,pageUrl:e,noTimeout:!!n.disableTimeouts},{flush:!0}),{ok:!1,message:"未启用任何规则，请在规则管理中开启后重试"};const{scripts:l,endpoints:w,documents:R,targets:p}=await ft(t,n.includeInline),y=l.filter(o=>!I(o.url,n)),g=(R??[]).filter(o=>!!o.content),A=new Set(y.map(o=>o.url)),h=[];for(const o of(p??[]).slice(0,B*5))if(o&&!A.has(o)&&!I(o,n)&&lt(o)&&(h.push({url:o,inline:!1}),h.length>=B))break;const u=[...g,...y,...h];if(!u.length)return k.delete(a),await f(i,{processed:0,total:0,current:null,status:"未获取到脚本",loading:!1,pageUrl:e,noTimeout:!!n.disableTimeouts},{flush:!0}),{ok:!1,message:"未获取到可扫描内容"};let T=0;chrome.runtime.sendMessage({type:"SCAN_PROGRESS",processed:0,total:u.length,tabId:t}),await f(i,{processed:0,total:u.length,current:null,status:"正在扫描",loading:!0,pageUrl:e,noTimeout:!!n.disableTimeouts},{flush:!0});let m=0;try{for(const o of u){try{const d=await ht(o,n,e);if(!d)continue;const{findings:b,contentHash:M,size:z}=await it(d,o.url,c,n.disableTimeouts?0:n.scanTimeoutMs,$=>!P($,n.outputBlacklist)&&!Q($,n.fullUrlIgnoreExtensions)),C=b;C.length&&(T+=C.length,await D(C),chrome.runtime.sendMessage({type:"SCAN_PARTIAL",script:o.url,added:C.length,tabId:t})),await X({id:M,url:o.url,inline:o.inline,contentHash:M,size:z,fetchedAt:Date.now()})}catch(d){console.warn("资源处理失败",o.url,d)}m+=1,await f(i,{processed:m,total:u.length,current:o.url,status:`扫描中 ${m}/${u.length}`,loading:!0,pageUrl:e,noTimeout:!!n.disableTimeouts}),chrome.runtime.sendMessage({type:"SCAN_PROGRESS",processed:m,total:u.length,current:o.url,tabId:t})}if(w?.length){const o=[];for(const d of w){if(!d.url||I(d.url,n)||P(d.url,n.outputBlacklist))continue;const b=await L(`runtime-endpoint:${d.url}`);o.push({id:b,type:"endpoint",rule:"runtime-endpoint",value:d.url,context:d.method?d.method:"",url:d.url,scriptUrl:d.url,createdAt:Date.now()})}o.length&&(T+=o.length,await D(o),chrome.runtime.sendMessage({type:"SCAN_PARTIAL",script:"runtime-endpoints",added:o.length,tabId:t}))}return await f(i,{processed:u.length,total:u.length,current:null,status:`扫描完成，处理 ${u.length} 个资源`,loading:!1,pageUrl:e,noTimeout:!!n.disableTimeouts},{flush:!0}),chrome.runtime.sendMessage({type:"SCAN_DONE",total:u.length,findings:T,tabId:t}),{ok:!0,message:`扫描完成，发现 ${T} 条疑似敏感信息`}}finally{k.delete(a);const o=await j(i);o?.loading&&await f(i,{...o,loading:!1,status:o.status||"扫描中断或超时",pageUrl:e,noTimeout:!!n.disableTimeouts},{flush:!0})}}async function ft(t,e){try{const n=await chrome.tabs.sendMessage(t,{type:"COLLECT_SCRIPTS",includeInline:e});return{scripts:n?.scripts??[],endpoints:n?.endpoints??[],documents:n?.documents??[],targets:n?.targets??[]}}catch(n){return console.error("向 content script 请求脚本失败",n),{scripts:[],endpoints:[],documents:[],targets:[]}}}async function ht(t,e,n){if(t.inline)return t.content??"";if(!t.url)return"";const s=new AbortController,r=!e.disableTimeouts&&e.requestTimeoutMs>0?setTimeout(()=>s.abort(),e.requestTimeoutMs):null;let i="omit";try{if(n){const c=new URL(n).origin,l=new URL(t.url).origin;c===l&&(i="include")}}catch{}try{const c=await fetch(t.url,{method:"GET",credentials:i,mode:"cors",signal:s.signal});if(!c.ok)return console.warn("拉取脚本失败",t.url,c.status),"";const l=await c.text(),w=l.length/1024;return w>e.maxContentSizeKB?(console.warn("脚本超出大小限制，已跳过",t.url,w),""):l}catch(c){return console.warn("获取脚本内容异常",t.url,c),""}finally{r&&clearTimeout(r)}}async function mt(t){switch(t.type){case"SCAN_ACTIVE_TAB":return dt();case"GET_FINDINGS":return t.host?{ok:!0,findings:await U(t.host,t.limit??50,t.offset??0)}:{ok:!0,findings:await J(t.limit??50,t.offset??0)};case"CLEAR_DATA":if(t.host?await W(t.host):await Y(),t.tabId)try{const e=await chrome.tabs.get(t.tabId);e?.url&&await et(e.url)}catch{}return{ok:!0};case"GET_SETTINGS":return{ok:!0,settings:await x()};case"SAVE_SETTINGS":return{ok:!0,settings:await q(t.settings)};case"GET_SCAN_STATE":try{const e=await chrome.tabs.get(t.tabId);if(!e?.url)return{ok:!0,state:null};const n=await N(e.url),s=await j(n);return{ok:!0,state:s?{...s}:null}}catch{return{ok:!0,state:null}}default:return{ok:!1,message:"未知指令"}}}function wt(){chrome.runtime.onInstalled.addListener(()=>{console.log("ShadowSeek 扩展已安装，等待扫描命令。")}),chrome.runtime.onMessage.addListener((t,e,n)=>(mt(t).then(s=>n(s)).catch(s=>{console.error("消息处理失败",s),n({ok:!1,message:s?.message??"处理失败"})}),!0)),chrome.tabs.onUpdated.addListener(async(t,e,n)=>{if(e.status!=="complete")return;const s=await x();s.autoScan&&(!n.url||!n.url.startsWith("http")||await H(t,n.url,s))})}wt();
